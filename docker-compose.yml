services:
  api-gateway:
    build:
      context: .
      dockerfile: api-gateway/Dockerfile
    depends_on:
      - employee-service
      - approval-request-service
      - approval-processing-service
      - notification-service
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
      JWT_SECRET: ${JWT_SECRET}
      EMPLOYEE_SERVICE_URL: ${EMPLOYEE_SERVICE_URL}
      APPROVAL_REQUEST_SERVICE_URL: ${APPROVAL_REQUEST_SERVICE_URL}
      APPROVAL_PROCESSING_SERVICE_URL: ${APPROVAL_PROCESSING_SERVICE_URL}
      NOTIFICATION_SERVICE_URL: ${NOTIFICATION_SERVICE_URL}
    ports:
      - "8080:8080"

  employee-service:
    build:
      context: .
      dockerfile: employee-service/Dockerfile
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRATION_MINUTES: ${JWT_EXPIRATION_MINUTES}
      EMPLOYEE_DB_HOST: mysql
      EMPLOYEE_DB_PORT: ${EMPLOYEE_DB_PORT}
      EMPLOYEE_DB_NAME: ${EMPLOYEE_DB_NAME}
      EMPLOYEE_DB_USERNAME: ${EMPLOYEE_DB_USERNAME}
      EMPLOYEE_DB_PASSWORD: ${EMPLOYEE_DB_PASSWORD}
      EMPLOYEE_ADMIN_EMAIL: ${EMPLOYEE_ADMIN_EMAIL}
      EMPLOYEE_ADMIN_NAME: ${EMPLOYEE_ADMIN_NAME}
      EMPLOYEE_ADMIN_DEPT: ${EMPLOYEE_ADMIN_DEPT}
      EMPLOYEE_ADMIN_POSITION: ${EMPLOYEE_ADMIN_POSITION}
      EMPLOYEE_ADMIN_ROLE: ${EMPLOYEE_ADMIN_ROLE}
      EMPLOYEE_ADMIN_PASSWORD: ${EMPLOYEE_ADMIN_PASSWORD}
    ports:
      - "8081:8080"

  approval-request-service:
    build:
      context: .
      dockerfile: approval-request-service/Dockerfile
    depends_on:
      mongo:
        condition: service_healthy
      approval-processing-service:
        condition: service_started
      employee-service:
        condition: service_started
      notification-service:
        condition: service_started
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
      JWT_SECRET: ${JWT_SECRET}
      APPROVAL_REQUEST_MONGO_HOST: ${APPROVAL_REQUEST_MONGO_HOST}
      APPROVAL_REQUEST_MONGO_PORT: ${APPROVAL_REQUEST_MONGO_PORT}
      APPROVAL_REQUEST_MONGO_DB_NAME: ${APPROVAL_REQUEST_MONGO_DB_NAME}
      APPROVAL_REQUEST_MONGO_USERNAME: ${APPROVAL_REQUEST_MONGO_USERNAME}
      APPROVAL_REQUEST_MONGO_PASSWORD: ${APPROVAL_REQUEST_MONGO_PASSWORD}
      APPROVAL_REQUEST_MONGO_AUTH_DB: ${APPROVAL_REQUEST_MONGO_AUTH_DB}
      APPROVAL_PROCESSING_GRPC_ADDRESS: ${APPROVAL_PROCESSING_GRPC_ADDRESS}
      EMPLOYEE_SERVICE_BASE_URL: ${EMPLOYEE_SERVICE_BASE_URL}
      NOTIFICATION_BASE_URL: ${NOTIFICATION_BASE_URL}
    ports:
      - "8082:8080"
      - "9091:9091"

  approval-processing-service:
    build:
      context: .
      dockerfile: approval-processing-service/Dockerfile
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
      JWT_SECRET: ${JWT_SECRET}
      APPROVAL_REQUEST_GRPC_ADDRESS: ${APPROVAL_REQUEST_GRPC_ADDRESS}
    ports:
      - "8084:8080"
      - "9090:9090"

  notification-service:
    build:
      context: .
      dockerfile: notification-service/Dockerfile
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
      JWT_SECRET: ${JWT_SECRET}
    ports:
      - "8083:8080"

  mysql:
    image: mysql:8
    environment:
      MYSQL_DATABASE: ${EMPLOYEE_DB_NAME}
      MYSQL_USER: ${EMPLOYEE_DB_USERNAME}
      MYSQL_PASSWORD: ${EMPLOYEE_DB_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${EMPLOYEE_DB_PASSWORD}
      TZ: UTC
    command: ["mysqld", "--character-set-server=utf8mb4", "--collation-server=utf8mb4_unicode_ci"]
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-p${EMPLOYEE_DB_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5

  mongo:
    image: mongo:8.2
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${APPROVAL_REQUEST_MONGO_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${APPROVAL_REQUEST_MONGO_PASSWORD}
      MONGO_INITDB_DATABASE: ${APPROVAL_REQUEST_MONGO_DB_NAME}
      MONGO_REPL_KEY: ${MONGO_REPL_KEY}
    command: ["bash", "-c", "set -e; if [ ! -f /data/configdb/keyfile ]; then umask 077; echo \"$MONGO_REPL_KEY\" > /data/configdb/keyfile; fi; exec docker-entrypoint.sh mongod --replSet docker-rs --bind_ip_all --auth --keyFile /data/configdb/keyfile"]
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--username", "${APPROVAL_REQUEST_MONGO_USERNAME}", "--password", "${APPROVAL_REQUEST_MONGO_PASSWORD}", "--authenticationDatabase", "${APPROVAL_REQUEST_MONGO_AUTH_DB}", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  mongo-init-replica:
    image: mongo:8.2
    depends_on:
      mongo:
        condition: service_healthy
    entrypoint: ["sh", "-c", "\
      set -e; \
      echo '[mongo-init] waiting for mongo:27017 to accept connections...'; \
      for i in $(seq 1 30); do \
        if mongosh --host mongo --username ${APPROVAL_REQUEST_MONGO_USERNAME} --password ${APPROVAL_REQUEST_MONGO_PASSWORD} --authenticationDatabase ${APPROVAL_REQUEST_MONGO_AUTH_DB} --quiet --eval \"db.adminCommand('ping')\" >/dev/null 2>&1; then \
          break; \
        fi; \
        sleep 2; \
      done; \
      echo '[mongo-init] checking replSet status...'; \
      if mongosh --host mongo --username ${APPROVAL_REQUEST_MONGO_USERNAME} --password ${APPROVAL_REQUEST_MONGO_PASSWORD} --authenticationDatabase ${APPROVAL_REQUEST_MONGO_AUTH_DB} --quiet --eval \"rs.status().members\" >/dev/null 2>&1; then \
        echo '[mongo-init] replSet already initiated, exit 0'; \
        exit 0; \
      fi; \
      echo '[mongo-init] initiating replSet docker-rs'; \
      mongosh --host mongo --username ${APPROVAL_REQUEST_MONGO_USERNAME} --password ${APPROVAL_REQUEST_MONGO_PASSWORD} --authenticationDatabase ${APPROVAL_REQUEST_MONGO_AUTH_DB} --quiet --eval \"rs.initiate({_id:'docker-rs',members:[{_id:0,host:'mongo:27017'}]})\"; \
      \
      echo '[mongo-init] done.'
    "]
    restart: on-failure

volumes:
  mysql_data:
  mongo_data:
